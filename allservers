#!/bin/bash
# The allservers script (I dropped the .sh off of the end) was
# written by handy, with a little help from others, it is
# released under a free for all public domain license, do what
# you will with it. 
#
# The most recent "reverse" history follows:.
#
# 04-May-2017: Modified to my liking, removed --no-confirm, added verbose
# option to pkgcacheclean and added script to check for pacnew and pacsave 
# files. - sotramk

# 18-July-2016: Added a sixth menu option that allows the user to delete
# the db.lck file that obstructs an upgrade after an incomplete/interupted
# upgrade attempt. This option will be a little time saver every now & then.
#
# 15-Jan-2015: Modified the script so that it is NOT called via an alias
# with sudo su -c , the script now uses sudo internally.
# Options [2] & [3] now have the --noconfirm parameter added, try it,
# if you don't like it, then delete --noconfirm from the script.
#
# 22-May-2014: Changed the title name to allservers . (Big change huh?)
#
# 20-November-2013: Removed stuff from the menu that really next to
# no one needs to see. The menu just does its job now, nothing more or less.
#
# 17-November-2013: I've finally felt like spending the time to improve
# (imho) the colours of the menu & I've also refined it some.
#
# 10-July-2013: Now using pkgCacheClean instead of CacheClean. It uses
# pacman's version checking method.
#
# 11-June-2013: Made Option 1. available (it is useful on the odd occasion).
# Made the display more informative during the progress of each option.
#
# 13-May-2013: Removed the ability for Option 1. to be run standalone, 
# due to having been told to read this:
# https://wiki.archlinux.org/index.php/Pacman#Partial_upgrades_are_unsupported 
#
# 27-April-2013: Updated to use the new pacman-mirrors -g to rankmirrors. 
#
# The script started in 2012, that history is not needed.
#
# allservers.sh - inspired by Manjaro's Carl & Philm, initially hung together 
# by handy, the script's display prettied up & progress information added by Philm, 
# the menu & wiki page added by handy.
# Latest revision now calls everything via the menu.
# The following wiki page is about this script & you should know
# as you are in it!: 
# https://wiki.manjaro.org/index.php?title=Allservers.sh_Script
#
###########################################################

err() {
   ALL_OFF="\e[1;0m"
   BOLD="\e[1;1m"
   RED="${BOLD}\e[1;31m"
    local mesg=$1; shift
    printf "${RED}==>${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@" >&2
}

msg() {
   ALL_OFF="\e[1;0m"
   BOLD="\e[1;1m"
   GREEN="${BOLD}\e[1;32m"
    local mesg=$1; shift
    printf "${GREEN}==>${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@" >&2
}


# The menu:

clear # Clear the screen.

echo
echo -e "\e[1;32m                             allservers"
echo
echo -e " \e[0;33m   Enter Your chosen Option's number \e[0;32m[\e[1;37m?\e[0;32m] \e[4;37mOR\e[0m\e[0;32m hit \e[0;31mReturn\e[0;32m to \e[0;31mexit\e[0;32m. "
echo
echo
echo -e "    [\e[1;37m1\e[0;32m] Create & update mirrorlist: \033[0mpacman-mirrors -ic all" 
echo -e "       \e[0;33m &\e[0;32m then sync/refresh package lists: \033[0mpacman -Syy "
echo
echo -e "   \e[0;32m [\e[1;37m2\e[0;32m] Option 1. \e[0;33mplus\e[0;32m Upgrade the System: \033[0mpacman -Syu"
echo -e "       \e[0;33m &\e[0;32m then run pkgCacheClean: \033[0mpkgcacheclean "
echo
echo -e "   \e[0;32m [\e[1;37m3\e[0;32m] Option 1. \e[0;33mplus\e[0;32m Upgrade the System & AUR: \033[0mpacaur -Syyu"
echo -e "       \e[0;33m &\e[0;32m then run pkgCacheClean: \033[0mpkgcacheclean "
echo
echo -e "   \e[0;32m [\e[1;37m4\e[0;32m] Upgrade the System only: \033[0mpacman -Syu "
echo -e "       \e[0;33m &\e[0;32m then run pkgCacheClean: \033[0mpkgcacheclean "
echo
echo -e "   \e[0;32m [\e[1;37m5\e[0;32m] Upgrade the System & AUR only: \033[0mpacaur -Syyu "
echo -e "       \e[0;33m &\e[0;32m then run pkgCacheClean: \033[0mpkgcacheclean "
echo
echo -e "   \e[0;32m [\e[1;37m6\e[0;32m] Delete \e[0;33mdb.lck\e[0;32m after interupted upgrade: \033[0mrm /var/lib/pacman/db.lck "
echo -e "       \e[0;32m this should remedy the unable to lock database error. "
echo 
echo -e "\033[1m  Enter the Number of Your Choice: \033[0m"
echo    

read option

case "$option" in
# Note variable is quoted.

 "1")
 echo
 msg "Create Mirror List:"
 echo
 sudo pacman-mirrors -ic all 
 echo
 msg "Your mirrors have been ranked &"
 msg "the mirrorlist has now been refreshed."
 echo
 msg "Refreshing your pacman database:"
 sudo pacman -Syy
 echo
 msg "Your mirrors & package database are now synchronised."
 echo
 ;;
# Note double semicolon to terminate each option.

 "2")
 echo
 msg "Processing mirrors:"
 echo
 sudo pacman-mirrors -g
 echo
 msg "Your mirrors have been ranked &"
 msg "the mirrorlist has now been refreshed."
 echo
 msg "Refreshing your pacman database:"
 sudo pacman -Syy
 echo
 msg "Your mirrors & package database are now synchronised."
 echo
 msg "Upgrading System:"
 echo
 sudo pacman -Syu 
 echo
 msg "System upgrade complete."
 echo
 msg "pkgCacheClean will now remove all but the 2 most "
 msg "recent versions of the installation packages in "
 msg "/var/cache/pacman/pkg directory:"
 echo
 sudo pkgcacheclean -kv
 echo
 msg "pkgCacheClean has done its job. "
 echo
 grep --extended-regexp "pac(new|save)" /var/log/pacman.log
  ;;
# Note double semicolon to terminate each option.

 "3")
 echo
 msg "Processing mirrors:"
 echo
 sudo pacman-mirrors -g
 echo
 msg "Your mirrors have been ranked &"
 msg "the mirrorlist has now been refreshed."
 echo
 msg "Refreshing your pacman database:"
 sudo pacman -Syy
 echo
 msg "Your mirrors & package database are now synchronised."
 echo
 msg "Upgrading System & AUR:"
 echo
 pacaur -Syyu 
 echo
 msg "System including AUR packages are up to date."
 echo
 msg "pkgCacheClean will now remove all but the 2 most "
 msg "recent versions of the installation packages in "
 msg "/var/cache/pacman/pkg directory:"
 echo
 sudo pkgcacheclean -kv
 echo
 msg "pkgCacheClean has done its job. "
 echo
 #locate --existing --regex "\.pac(new|orig\save)$"
 #grep --extended-regexp "pac(new|save)" /var/log/pacman.log
 yaourt -C
 ;;
# Note double semicolon to terminate each option.

 "4")
 echo
 msg "Upgrading System:"
 echo
 sudo pacman -Syu
 echo
 msg "System update complete."
 echo
 msg "pkgCacheClean will now remove all but the 2 most "
 msg "recent versions of the installation packages in "
 msg "/var/cache/pacman/pkg directory:"
 echo
 sudo pkgcacheclean -kv
 echo
 msg "pkgCacheClean has done its job. "
 echo
 grep --extended-regexp "pac(new|save)" /var/log/pacman.log
 ;;
# Note double semicolon to terminate each option.

 "5")
 echo
 msg "Upgrading System & AUR: "
 echo
 pacaur -Syyu
 echo
 msg "System including AUR packages are up to date. "
 echo
 msg "pkgCacheClean will now remove all but the 2 most "
 msg "recent versions of the installation packages in "
 msg "/var/cache/pacman/pkg directory:"
 echo
 sudo pkgcacheclean -vk
 echo
 msg "pkgCacheClean has done its job. "
 echo
 grep --extended-regexp "pac(new|save)" /var/log/pacman.log
 ;;
# Note double semicolon to terminate each option.

"6")
 echo
 msg "About to delete /var/lib/pacman/db.lck: "
 echo
 sudo rm /var/lib/pacman/db.lck
 echo
 msg "File db.lck removed, re-attempt your intended installation. "
 echo
 ;;
# Note double semicolon to terminate each option.




esac

exit 0
